<!DOCTYPE html>
<html lang="en-us">
<head>

<title>公式编辑器</title>
<meta charset="utf-8"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"/>
<link rel="stylesheet" href="../css/note.css"/>
<style type="text/css">
div {
	padding: 10px 0;
}
#outputWrapper {
	margin-top: 45px;
}
#outputWrapper > div {
	text-align: center;
}
@media print {
	#outputWrapper > div {
		border: none !important;
	}
	#inputWrapper {
		display: none;
	}
}
</style>
</head>
<body>

<div id="outputWrapper"></div>

<div id="inputWrapper">
	<button id="copy">copy</button>
	<button id="newFormula">new</button>
	<button id="deleteFormula">delete</button>
	<button id="lang">asciimath</button>
	<textarea id="input" rows="5" lang="asciimath"></textarea>
</div>

<script>
function render() {
	if (input.lang == 'asciimath') {
		output.asciimath = input.value;
		output.innerHTML = '`' + output.asciimath + '`';
		if (asciimath) {
			asciimath.render(output);
			output.tex = asciimath.texstr;
		}
	} else {
		output.tex = input.value;
		output.innerHTML = input.value;
		katex.render(input.value, output);
	}
} 	 

var asciimath = {
	katexpath: '../js/katex.min.js',
	katex: true,
	onload: render,
};
</script>
<script src="../js/asciimath.js"></script>
<script>
var count = 0;
var input = document.getElementById('input');
var output = document.getElementById('output');
var copy = document.getElementById('copy');
var lang = document.getElementById('lang');
var outputWrapper = document.getElementById('outputWrapper');

input.onkeyup = function(event) {
	if (event.keyCode || event.which)
		render();
};

lang.onclick = function() {
	if (input.lang == 'asciimath') {
		lang.innerHTML = 'tex';
		input.lang = 'tex';
		input.value = output.tex;
	} else {
		lang.innerHTML = 'asciimath';
		input.lang = 'asciimath';
		input.value = output.asciimath || '';
	}
};

copy.onclick = function() {
	input.select();
	document.execCommand('copy');
	input.blur();
};

function highlight(elem) {
	if (output) output.style.border = 'none';
	elem.style.border = '1px solid #aaa';
	output = elem;
	if (input.lang == 'tex')
		input.value = output.tex || '';
	else // if (input.lang == 'asciimath')
		input.value = output.asciimath || '';
	input.focus();
}

deleteFormula.onclick = function() {
	var formulae = outputWrapper.children;
	if (formulae.length > 1) {
		outputWrapper.removeChild(output);
		highlight(formulae[formulae.length-1]);
	}
};

newFormula.onclick = function() {
	var div = document.createElement('div');
	div.onclick = function() {
		highlight(div);
	}
	highlight(div);
	outputWrapper.appendChild(div);
};

newFormula.onclick();
input.value = 'x = (-b+-sqrt(b^2-4ac))/(2a)';
</script>
</body>
</html>
