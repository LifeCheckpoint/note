<style>
* {
  box-sizing: border-box;
}
body {
  background-color: #222;
}
.g-absolute {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
}
.input {
  position: relative;
  background: #333;
  width: 100%;
  height: 500px;
  border-radius: 4px;
  color: #aaa;
}
.input-area {
  color: transparent;
  background: transparent;
  resize: none;
  border: none;
  caret-color: #eee;
}
.input-bg,
.input-area {
  padding: 8px;
  font-family: monospace;
  font-size: 20px;
  line-height: 30px;
  line-break: anywhere;
  white-space: pre-wrap;
}

.color-normal {
  color: #eee;
}
.color-dim {
  color: #aaa;
}
.color-error {
  color: #e88;
}
.bg-gold {
  background-image: linear-gradient(45deg, #ff8400, gold);
}
.anim-gold {
  background-image: linear-gradient(45deg, #ff9d0b, gold, #ff9d0b, gold);
  background-size: 200%;
  animation: anim-gold 4s infinite linear;
}
@keyframes anim-gold {
  0% { background-position: 0% 0%; }
  50% { background-position: 300% 0%; }
  100% { background-position: 600% 0%; }
}

.tool-bar {
  padding: 8px 0;
  text-align: right;
}
.btn {
  display: inline-flex;
  align-items: center;
  padding: 8px 16px;
  border-radius: 2px;
  font-size: 14px;
  cursor: pointer;
  background-color: #1976d2;
  color: white;
  border: none;
  opacity: 0.9;
}
.btn:active {
  opacity: 1;
}
.status-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #222;
  border-top: 1px solid #303030;
  color: #ccc;
  font-size: 14px;
  line-height: 24px;
  display: flex;
  gap: 4px;
}
.status-badge {
  background-color: #1976d2;
  padding: 0 10px;
  margin-right: 4px;
}
.status-divider {
  border-right: 1px solid #303030;
  margin: 4px;
}

.toast {
  background-color: #1976d2;
  color: #eee;
  border-radius: 8px;
  padding: 8px;
  transition: opacity .5s;
  height: 132px;
  width: 132px;
  font-size: 14px;
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
.toast-header {
  font-size: 32px;
  line-height: 50px;
  margin-bottom: 8px;
}
</style>

<div class="input">
  <div class="input-bg g-absolute"></div>
  <textarea class="input-area g-absolute" disabled></textarea>
</div>

<div class="tool-bar">
  <button class="btn btn-load">载文</button>
</div>

<div class="status-bar">
  <span class="status-badge">--</span>
  <span class="status-time">00:00.000</span>
  <span class="status-divider"></span>
  <span class="status-speed" title="字/分">0.00 速</span>
  <span class="status-divider"></span>
  <span class="status-key-speed" title="键/秒">0.00 击</span>
  <span class="status-divider"></span>
  <span class="status-acc">100.00%</span>
</div>

<script>
const $ = el => document.querySelector(el)
const $inputArea = $('.input-area')
const $inputBg = $('.input-bg')
const $statusBadge = $('.status-badge')
const $statusTime = $('.status-time')
const $statusSpeed = $('.status-speed')
const $statusKeySpeed = $('.status-key-speed')
const $statusAcc = $('.status-acc')
const $btnLoad = $('.btn-load')
// const exampleText = `Ipsum culpa aut laboriosam eos amet. Maiores pariatur velit ea magnam at, impedit maiores, optio! Saepe incidunt nisi delectus tenetur culpa! Impedit tempore non veniam voluptate voluptate suscipit laudantium Eligendi.` // TODO
const exampleText = `大大大小小小
一二三四五六七`

// 当前打字信息
let currentTyping = {}
const typingHistory = []

// 处理空格与换行
const processText = (text) => {
  // 将最后一个空格外的所有空格换成占位符
  return (text.slice(0, -1).replace(/ /g, '␣') + text.slice(-1))
    // 将换行换成占位符
    .replace(/↵\n|\r\n|\n|\r/g, '↵')
}

// 还原换行符
const restoreLinebreak = (text) => {
  return text.replace(/↵/g, '↵\n')
}

// 更新背景文字
const updateBg = (text) => {
  const res = []
  const buf = []
  let className = ''
  const flush = () => {
    if (buf.length) {
      res.push(`<span class="${className}">${buf.join('')}</span>`)
      buf.length = 0
    }
  }
  let correctCount = 0
  let errorCount = 0
  text.forEach((c1, i) => {
    const c2 = currentTyping.text[i]
    const cls = c1 === c2 ? 'color-normal' : 'color-error'
    if (c1 === c2) {
      ++correctCount
    } else {
      ++errorCount
    }
    if (cls !== className) {
      flush()
      className = cls
    }
    buf.push(c1)
  })
  currentTyping.correctCount = correctCount
  currentTyping.errorCount = errorCount
  flush()
  className = 'color-dim'
  buf.push(...currentTyping.text.slice(text.length))
  flush()
  return res.join('')
}

const startTyping = () => {
  const text = processText(exampleText)
  $inputBg.innerText = restoreLinebreak(text)
  $inputArea.value = ''
  $inputArea.disabled = false
  $inputArea.focus()
  currentTyping = {
    text: [...text], // 待输入文本
    pauseTime: 0, // 上一次暂停输入的时刻
    startTime: 0, // 开始输入的时刻 (扣除暂停时间)
    timer: undefined, // interval 定时器
    correctCount: 0, // 正确字数
    errorCount: 0, // 错误字数
    backspaceCount: 0, // 回改数
    keyCount: 0, // 击键数
  }
}

const finishTyping = () => {
  $inputArea.disabled = true
  clearInterval(currentTyping.timer)
  currentTyping.timer = undefined
  updateStatus()
  typingHistory.push(currentTyping)

  const badge = $statusBadge.textContent
  const className = badge === 'φ' ? 'toast anim-gold' : 'toast'
  toast(`
    <div class="toast-header">${$statusBadge.textContent}</div>
    <div>${$statusSpeed.textContent}</div>
    <div>${$statusKeySpeed.textContent}</div>
    <div>${$statusAcc.textContent}</div>
  `, className)

  $btnLoad.focus()
}

const toast = (text, className = 'toast') => {
  const $toast = $('.toast') || document.createElement('div')
  $toast.className = className
  $toast.innerHTML = text
  Object.assign($toast.style, {
    display: 'block',
    opacity: '1',
  })
  document.body.append($toast)
  setTimeout(() => {
    $toast.style.opacity = '0'
  }, 2000)
  setTimeout(() => {
    $toast.style.display = 'none'
  }, 2500)
}

const pauseTyping = () => {
  clearInterval(currentTyping.timer)
  currentTyping.timer = undefined
  currentTyping.pauseTime = new Date().valueOf()
}

const resumeTyping = () => {
  currentTyping.startTime += new Date().valueOf() - currentTyping.pauseTime
  currentTyping.timer = setInterval(updateStatus, 50)
}

const pad = (x, len, str = '0') => {
  return (str.repeat(len) + x).slice(-len)
}

// 计算字母评分
const getBadge = (speed, acc) => {
  return speed > 200 && acc >= 100? 'φ'
    : speed > 150 ? 'V+'
    : speed > 120 ? 'V'
    : speed > 100 ? 'S'
    : speed > 80 ? 'A'
    : speed > 60 ? 'B'
    : speed > 40 ? 'C'
    : 'D'
}

// 更新状态栏
const updateStatus = () => {
  const millis = new Date().valueOf() - currentTyping.startTime
  // const hh = pad(millis / (1000 * 3600) | 0, 2)
  const mm = pad(millis % (1000 * 3600) / (1000 * 60) | 0, 2)
  const ss = pad(millis % (1000 * 60) / 1000 | 0, 2)
  const ms = pad(millis % 1000, 3)
  const { correctCount, errorCount, backspaceCount, keyCount } = currentTyping
  const speed = correctCount * 1000 * 60 / millis
  const keySpeed = keyCount * 1000 / millis
  const acc = (1 - backspaceCount / keyCount) * (correctCount / (correctCount + errorCount)) * 100
  const badge = getBadge(speed, acc)
  $statusTime.textContent = `${mm}:${ss}.${ms}`
  $statusSpeed.textContent = speed.toFixed(2) + ' 速'
  $statusKeySpeed.textContent = keySpeed.toFixed(2) + ' 击'
  $statusAcc.textContent = acc.toFixed(2) + '%'
  $statusBadge.textContent = badge
  if (badge === 'φ') {
    $statusBadge.classList.add('bg-gold')
  } else {
    $statusBadge.classList.remove('bg-gold')
  }
}

// 文本框输入事件
const onInput = (e) => {
  // 用户输入时开始记时
  if (!currentTyping.timer) {
    resumeTyping()
  }
  const value = processText(e.target.value)
  e.target.value = restoreLinebreak(value)

  const text = [...value]
  const isFinish = text.length === currentTyping.text.length
  const isCorrect = text[text.length - 1] === currentTyping.text[text.length - 1]
  $inputBg.innerHTML = restoreLinebreak(updateBg([...value]))
  if (isFinish && isCorrect) {
    finishTyping()
  }
}

$btnLoad.onclick = startTyping
$inputArea.oninput = onInput
$inputArea.onblur = pauseTyping
$inputArea.oncontextmenu = (e) => {
  e.preventDefault()
}
$inputArea.onkeydown = (e) => {
  // 禁用粘贴
  if (e.ctrlKey && e.code === 'KeyV') {
    e.preventDefault()
  } else if (e.code === 'Backspace') {
    ++currentTyping.backspaceCount
  } else {
    ++currentTyping.keyCount
  }
}
</script>
