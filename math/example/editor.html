<!DOCTYPE html>
<html lang="en-us">
<head>

<title>公式编辑器</title>
<meta charset="utf-8"/>
<link rel="stylesheet" href="../css/note.css"/>
<style type="text/css">
#outputWrapper {
  border: 1px solid #ccc; 
  background: white;
  margin: 55px 0 10px 0;
}
#outputWrapper div {
  padding: 10px 0;
  text-align: center;
}
#outputWrapper div:hover {
  background: #dde;
  cursor: default;
}
#outputWrapper div.highlight {
  border-left: 5px solid #56a;
  margin: 0;
}
#keyboard {
  padding: 0;
}
#keyboard button {
  margin: 5px 0;
  border-width: 1px;
  text-align: center;
  min-width: 40px;
  height: 40px;
}
#input {
  margin: 10px 0;
}
@media print {
  #outputWrapper {
    border: none;
  }
  #outputWrapper > div {
    border: none !important;
  }
  #inputWrapper,#help {
    display: none;
  }
}
</style>
</head>
<body>

<div id="outputWrapper"></div>

<div id="inputWrapper">
  <button onclick="toggleKeyboard()">keyboard</button>
  <button id="copy">copy</button>
  <button id="newFormula">add</button>
  <button id="deleteFormula">remove</button>
  <button id="lang">asciimath</button>
  <div id="keyboard" hidden>
    <button>+</button>
    <button>-</button>
    <button>*</button>
    <button>/</button>
    <button>=</button>
    <button>^</button>
    <button>_</button>
    <button name="sqrt">&#x221a;</button>
    <button name="root n"><sup>n</sup>&#x221a;</button>
    <button name="int">&#x222b;</button>
    <button name="sum">&Sigma;</button>
    <button name="prod">&Pi;</button>
    <button name="oo">&#x221e;</button>
    <button value="1">()</button>
    <button value="1">[]</button>
    <button value="1">{}</button>
    <button name="[a,b;c,d]">[..]</button>
    <button name="``" value="1">T</button>
  </div>
  <textarea id="input" rows="5" lang="asciimath"></textarea>
</div>

<p id="help">
  <a target="_blank" href="asciimath.html">更多示例帮助?</a>
</p>

<script>
function render() {
  if (input.lang == 'asciimath') {
    output.asciimath = input.value;
    output.innerHTML = '`' + output.asciimath + '`';
    if (asciimath) {
      asciimath.render(output);
      output.tex = asciimath.texstr;
    }
  } else {
    output.tex = input.value;
    output.innerHTML = input.value;
    katex.render(input.value, output);
  }
}    

var asciimath = {
  katexpath: '../js/katex.min.js',
  katex: true,
  onload: render,
};
</script>
<script src="../js/asciimath.js"></script>
<script>
var input = document.getElementById('input');
var output = document.getElementById('output');
var copy = document.getElementById('copy');
var lang = document.getElementById('lang');
var keyboard = document.getElementById('keyboard');
var outputWrapper = document.getElementById('outputWrapper');

input.onkeyup = function(event) {
  if (event.keyCode || event.which)
    render();
};

function toggleKeyboard() {
  if (keyboard.hidden) {
    keyboard.removeAttribute('hidden');
  } else {
    keyboard.hidden = true;
  }
}

function getCaret(obj) {
  var result = 0;
  if (obj.selectionStart >= 0) { // IE 以外 
    result = obj.selectionStart;
  } else { // IE 
    try {
      var range;
      if (/textarea/i.test(obj.tagName)) { // TEXTAREA
        range = event.srcElement.createTextRange();
        range.moveToPoint(event.x, event.y);
      } else { // Text 
        range = document.selection.createRange();
      }
      range.moveStart("character", -event.srcElement.value.length);
      result = range.text.length;
    } catch(e) { }
  }
  return result;
}

function setCaret(textarea, pos) {
  if (textarea && pos) {
    if(textarea.setSelectionRange) {
      setTimeout(function() {
        textarea.setSelectionRange(pos, pos);
        textarea.focus();
      }, 0);
    } else if (textarea.createTextRange) {
      var range = textarea.createTextRange();
      range.move('character', pos);
      range.select();
    }
  }
}

function appendText(b) {
  var text = b.name || b.innerText;
  return function() {
    input.focus();
    var i = getCaret(input);
    input.value = input.value.substr(0,i) + text + input.value.substr(i);
    var pos = b.value ? i + parseInt(b.value): i + text.length;
    setCaret(input, pos);
    render();
  }
}

for (b of keyboard.children) {
  if (/button/i.test(b.tagName)) {
    b.onclick = appendText(b);
  }
}

lang.onclick = function() {
  if (input.lang == 'asciimath') {
    lang.innerText = 'tex';
    input.lang = 'tex';
    input.value = output.tex;
  } else {
    lang.innerText = 'asciimath';
    input.lang = 'asciimath';
    input.value = output.asciimath || '';
  }
};

copy.onclick = function() {
  input.select();
  document.execCommand('copy');
  input.blur();
};

function highlight(elem) {
  if (output)
    output.classList.remove('highlight');
  elem.classList.add('highlight');
  output = elem;
  if (input.lang == 'tex')
    input.value = output.tex || '';
  else // if (input.lang == 'asciimath')
    input.value = output.asciimath || '';
  input.focus();
}

deleteFormula.onclick = function() {
  var formulae = outputWrapper.children;
  if (formulae.length > 1) {
    outputWrapper.removeChild(output);
    highlight(formulae[formulae.length-1]);
  }
};

newFormula.onclick = function() {
  var div = document.createElement('div');
  div.onclick = function() {
    highlight(div);
  }
  highlight(div);
  outputWrapper.appendChild(div);
};

newFormula.onclick();
input.value = 'x = (-b+-sqrt(b^2-4ac))/(2a)';
</script>
</body>
</html>
