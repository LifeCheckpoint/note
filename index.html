<!DOCTYPE html>
<html lang="zh-cn">

<head>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>index</title>
<link id="favicon" rel="shortcut icon" href="img/pikachu.png"/>
<style type="text/css">
* {
  margin: 0;
  padding: 0;
}

body {
  text-rendering: optimizeLegibility;
  font-size: 16px;
  font-family: "-apple-system", "Helvetica Neue", "Roboto", "Segoe UI", sans-serif;
  overflow-x: hidden;
}

header {
  height: 45px;
  line-height: 45px;
  font-size: 18px;
  display: table;
  position: absolute;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  text-align: center;
  font-weight: 500;
  border-color: #000;
  background-color: #444;
  color: #fff;
  transition: 1s;
}

header a {
  height: 45px;
  width: 45px;
  display: table-cell;
  position: absolute;
  top: 0;
  border: none;
  color: inherit;
  font-size: inherit;
  font-weight: inherit;
  background: rgba(0,0,0,0);
  cursor: pointer;
  text-decoration: none;
}

header a:focus {
  border: none;
}

header a:first-child {
  left: 0;
}

header a:last-child {
  right: 0;
}

header span {
  display: table-cell;
  white-space: nowrap;
}

#notify {
  position: fixed;
  top: 10px;
  left: 40%;
  width: 20%;
  padding: 5px;
  border-radius: 5px;
  text-align: center;
  z-index: 10;
  color: white;
  background: #444;
  overflow: hidden;
}

#notify::before {
  content: '';
  position: absolute;
  background: white;
  bottom: 2px;
  left: -25%;
  height: 2px;
  width: 50%;
  animation: whitebar 1.5s infinite ease;
}

@keyframes whitebar {
  50% { left: 75% }
}

#nav {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  width: 0;
  display: flex;
  flex-flow: column nowrap;
  overflow-y: hidden;
  background: #fcfcfc;
  box-shadow: inset -14px 0px 5px -12px rgb(210,210,210);
  border-right: 1px #444;
  transition: .5s;
  z-index: 0;
}

#table-of-contents {
  margin-top: 45px;
  height: 100%;
  overflow: auto;
  list-style-type: none;
  color: #45a;
}

#table-of-contents ul {
  list-style-type: none;
}

#table-of-contents li {
  padding-left: 1em;
  line-height: 2em;
  /* both of the following are required for text-overflow */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#table-of-contents ul li {
  color: black;
/* 折叠目录
  height: 0;
  overflow-y: hidden;
  transition: .3s ease;
}

#table-of-contents > li:hover li {
  height: 2em;
  transition: .3s ease;
*/
}

#table-of-contents ul li:hover {
  background: #dde;
  cursor: pointer;
}

li.isnew::after {
  content: "NEW";
  color: red;
  font-size: 0.7em;
  padding: 0 0.3em;
}

#article {
  position: absolute;
  margin-left: 0;
  width: 100%;
  height: 100%;
  transition: .5s;
  z-index: 1;
}

#iframe {
  display: table;
  padding: 0;
  border: 0;
  width: 100%;
  height: 100%;
}

#eclipse {
  height: 100%;
  width: 100%;
  /*background: rgba(0,0,0,0.2);*/
  display: none;
  position: absolute;
  top: 0;
}

#yinyang {
  transition: .5s;
}

#book-wrapper {
  display: inline-block;
  position: relative; /* 正确显示箭头和文字的堆叠, 这是关键一步 */
  width: 50%;
  z-index: 1;
}

#book-wrapper::before {
  position: absolute;
  right: 10px;
  top: 18px;
  content: "";
  border: 10px solid transparent;
  border-top-color: white;
  cursor: pointer;
  z-index: -1;
}

#book {
  cursor: pointer;
  border: none;
  border-radius: 4px;
  color: inherit;
  background: transparent;
  background-image: none;
  height: 40px;
  width: 100%;
  font-size: inherit;
  text-align: center;
  -webkit-appearance: none;
  -moz-appearance: none;
}

#book option {
  color: black;
}

#book:focus {
  outline: none;
}

#body-yellow {
  background: #eec;
}

#body-green {
  background: #dfb;
}

#body-purple {
  background: #ddf;
}

#body-dark {
  background: #222;
}

#body-pink {
  background: #ecc;
}

/* mobile phone */
@media screen and (min-resolution: 150dpi) {}

/* iphone */
@media screen and (-webkit-min-device-pixel-ratio:2) {}
</style>

</head>

<body>

<nav id="nav" hidden>
  <ul id="table-of-contents"></ul>
  <header>
    <a id="prev-article">&#x276e;</a>
    <div id="book-wrapper">
      <select name="book" id="book">
        <!--&#x2304;-->
      </select>
    </div>
    <a id="next-article">&#x276f;</a>
  </header>
</nav>

<article id="article">
  <iframe id="iframe"></iframe>
  <header id="header">
    <a id="yinyang" title="M 键切换目录">&#x262f;</a>
    <span id="article-title"></span>
    <a href="mailto:892298182@qq.com" title="报错与反馈" style="font-size:1.5em; line-height:1.5em">&#x2709;</a>
    <!--<img src="img/envelope.svg" alt="&#x2709;" style="width: 20px; height: 20px; margin: 12px">-->
  </header>
  <div id="eclipse"></div>
</article>

<script src="js/toc.js"></script>
<script>
'use strict';
(function(){
// 假装在用 jquery
function $(str, children) {
  if (typeof(str) == 'string') {
    var len = str.length;
    if (str[0] == '#')
      return document.getElementById(str.slice(1));
    if (str[0] == '.')
      return document.getElementsByClassName(str.slice(1));
    if (str[0] == '<' && str[len-1] == '>') {
      var elem = document.createElement(str.slice(1,len-1));
      if (typeof(children) == 'string')
        elem.innerHTML = children;
      else if (children instanceof Node)
        elem.appendChild(children);
      else if (children instanceof Array) {
        for (c of children)
          elem.appendChild(c);
      }
      return elem;
    }
    if (len > 0)
      return document.getElementsByTagName(str);
  }
  if (typeof(str) == 'undefined') {
    return document.createDocumentFragment();
  }
}

// elements
var article = $('#article'),
  artitle = $('#article-title'),
  header = $('#header'),
  iframe = $('#iframe'),
  nav = $('#nav'),
  toc = $('#table-of-contents'),
  yinyang = $('#yinyang'),
  prevArticle = $('#prev-article'),
  nextArticle = $('#next-article'),
  book = $('#book'),
  favicon = $('#favicon'),
  eclipse = $('#eclipse');

var UUID = 'io.zmx0142857.';
var tableOfContents;

// 加载 toc.js 中的目录
for (var key in tocData) {
  var option = $('<option>', tocData[key].title);
  option.value = key;
  book.appendChild(option);
}

function hideNav(flag) {
  if (!nav.hidden || flag) {
    nav.hidden = true;
    nav.style.width = '0';
    article.style.marginLeft = '0';
    yinyang.style.transform = 'none';
    eclipse.style.display = 'none';
    headerVisible(false);
  } else {
    nav.removeAttribute('hidden');
    nav.style.width = '16em';
    article.style.marginLeft = '16em';
    yinyang.style.transform = 'rotate(540deg)';
    eclipse.style.display = 'block';
    headerVisible(true);
  }
}

function headerVisible(flag) {
  if (!nav.hidden || flag) {
    header.removeAttribute('hidden');
    header.style.opacity = '1';
  } else {
    header.hidden = true;
    header.style.opacity = '0';
  }
}

function loading() {
  var notify = $('#notify');
  if (!notify) {
    notify = $('<div>');
    notify.innerText = '加载中...';
    notify.id = 'notify';
    document.body.appendChild(notify);
  }
  iframe.onload = function() { document.body.removeChild(notify) };
}

function load(key, defaultVal) {
  return localStorage[UUID+key] || defaultVal;
}

function save(key, val) {
  localStorage[UUID+key] = val;
}

function jump(src, title) {
  //console.log('jump: ' + src + ' ' + title);
  loading();
  save('src', src);
  iframe.setAttribute('src', book.value + '/' + src);
  artitle.innerText = title;
  hideNav(true);
  setTimeout(headerVisible, 1000);
}

function jumpPos(pos) {
  var item = tableOfContents[pos[0]].articles[pos[1]];
  jump(item.src, item.title);
}

function redirect(pos) {
  var src = tableOfContents[pos[0]].articles[pos[1]].src.replace(/\.html$/, '');
  window.history.pushState({}, '', '#' + book.value + '/' + src);
  jumpPos(pos);
}

function jumpto(pos) {
  return function() {
    redirect(pos);
  };
}

function loadBook() {
  //console.log('load book');
  var bookData = tocData[book.value];
  tableOfContents = bookData.toc;
  document.title = 'zmx0142857 的' + bookData.title + '笔记';
  document.body.id = 'body-' + (bookData.color || 'yellow');
  favicon.href = 'img/' + (bookData.favicon || 'pikachu.png');

  // render table of contents
  var newtoc = $('<ul>');
  var frag = $();
  for (var i = 0; i < tableOfContents.length; ++i) {
    var LI = $('<li>', tableOfContents[i].title);
    var ul = $('<ul>');
    for (var j = 0; j < tableOfContents[i].articles.length; ++j) {
      var li = $('<li>', tableOfContents[i].articles[j].title);
      li.onclick = jumpto([i, j]);
      if (tableOfContents[i].articles[j].isnew)
        li.classList.add('isnew');
      ul.appendChild(li);
    }
    LI.appendChild(ul);
    frag.appendChild(LI);
  }
  newtoc.appendChild(frag);
  nav.replaceChild(newtoc, toc);
  newtoc.id = 'table-of-contents';
  toc = newtoc;
}

function getPos(src) {
  //console.log('getPos');
  for (var i = 0; i < tableOfContents.length; ++i) {
    for (var j = 0; j < tableOfContents[i].articles.length; ++j) {
      if (tableOfContents[i].articles[j].src == src) {
        return [i, j];
      }
    }
  }
  return [0, 0];
}

function parseHash() {
  var index = location.href.indexOf('#');
  if (index != -1) {
    var hash = location.href.slice(index+1);
    if (/^[^/]+\/[^/]+\/[^/]+$/.test(hash)) { // book/group/article
      var path = hash.split('/');
      if (path[0] != book.value) {
        book.value = path[0];
        save('book', path[0]);
        loadBook();
      }
      var src = path[1] + '/' + path[2] + '.html';
      return getPos(src);
    }
  }
}

// bind event listener
function handleKeyboard(e) {
  if (e.keyCode == 'M'.charCodeAt(0)) {
    hideNav();
  }
}
document.onkeyup = iframe.contentWindow.handleKeyboard = handleKeyboard;
header.onmouseover = function() {headerVisible(true)};
header.onmouseout = function() {headerVisible(false)};
yinyang.onclick = eclipse.onclick = function() {hideNav()};
prevArticle.onclick = function() {
  var pos = parseHash();
  if (pos[1] == 0) {
    if (pos[0] == 0) {
      console.warn('already at first article.');
      return;
    }
    pos[1] = tableOfContents[--pos[0]].articles.length;
  }
  --pos[1];
  redirect(pos);
};

nextArticle.onclick = function() {
  var pos = parseHash();
  if (pos[1] == tableOfContents[pos[0]].articles.length-1) {
    if (pos[0] == tableOfContents.length-1) {
      console.warn('no more articles.');
      return;
    }
    ++pos[0];
    pos[1] = -1;
  }
  ++pos[1];
  redirect(pos);
};

book.onchange = function() {
  var pos = [0, 0];
  save('book', book.value);
  loadBook();
  redirect(pos);
}

window.onpopstate = function(e) {
  var pos = parseHash();
  if (pos) {
    jumpPos(pos);
  } else { // fallback
    book.value = load('book', 'math');
    book.onchange();
  }
}

book.value = '';
window.onpopstate();

})();
</script>
</body>
</html>
